<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>五子棋</title>
    <meta name="viewport" content="width=device-width">
    <style type="text/css">
    body {
        margin: 0;
    }


    a,canvas,img,button,input,textarea{-webkit-tap-highlight-color:rgba(255,255,255,0);}

    #game {
        box-shadow: 3px 0px 10px 1px #dfdfdf;
        display: block;
        margin-left: auto;
        margin-right: auto;
        margin-top: 20px;
    }


    h1 {
        text-align: center;
    }

    </style>
</head>
<body>
    <h1>五子棋</h1>
    <canvas id="game" width="450" height="450"></canvas>


    <script type="text/javascript">

    var game = {

        init : function ( id, option ) {
            this.id = id;
            this.el = document.getElementById( id );
            this.ctx = this.el.getContext('2d');

            this.drawChess();
            this.initData();
            this.initEvent();
        },

        reset: function () {
            this.ctx.clearRect(0, 0, this.el.width, this.el.height);
            this.ctx.beginPath();
            this.init( this.id );
        },

        initData: function () {

            var i = 0, 
                j = 0,
                k = 0;

            this.me = true;
            // 棋盘格子
            this.borad = [];
            this.wins  = [];
            this.count = 0;
            this.myWin = [];
            this.computerWin = [];
            this.over = false;

            for (i = 0; i < 15; i++) {
                this.borad[i] = [];
                this.wins[i] = [];
                for (j = 0; j < 15; j++) {
                    // 0 代表这个格子是空的  1是黑子  2是白子
                    this.borad[i][j] = 0;
                    this.wins[i][j] = [];
                };
            };

            // 横
            for (i = 0; i < 15; i++) {
                for (j = 0; j < 11; j++) {
                    for (k = 0; k < 5; k++) {
                        this.wins[i][j + k][this.count] = true;
                    };
                    this.count++;
                };
            };

            // 竖
            for (i = 0; i < 15; i++) {
                for (j = 0; j < 11; j++) {
                    for (k = 0; k < 5; k++) {
                        this.wins[j + k][i][this.count] = true;
                    };
                    this.count++;
                };
            };

            // 斜
            for (i = 0; i < 11; i++) {
                for (j = 0; j < 11; j++) {
                    for (k = 0; k < 5; k++) {
                        this.wins[i + k][j + k][this.count] = true;
                    };
                    this.count++;
                };
            };

            // 反斜
            for (i = 0; i < 11; i++) {
                for (j = 14; j > 3; j--) {
                    for (k = 0; k < 5; k++) {
                        this.wins[i + k][j - k][this.count] = true;
                    };
                    this.count++;
                };
            };

            for (i = 0; i < this.count; i++) {
                this.myWin[i] = 0;
                this.computerWin[i] = 0;
            };
        },

        initEvent: function () {
            var _this = this;

            this.el.onclick = function (e) {

                if( _this.over ) {
                    return false;
                }
                if( !_this.me ) {
                    return false;
                }

                var x = e.offsetX;
                var y = e.offsetY;

                var i = Math.floor(x / 30);
                var j = Math.floor(y / 30);
                
                // 这个位置是否已经有棋子
                if( _this.borad[i][j] == 0 ) {

                    // 落子
                    _this.oneStep(i, j, _this.me);
                    _this.borad[i][j] = 1;

                    // 查看当前的赢法
                    for (var k = 0; k < _this.count; k++) {
                        if( _this.wins[i][j][k] ) {
                            _this.myWin[k]++;
                            _this.computerWin[k] = 6;

                            if( _this.myWin[k] == 5 ) {
                                _this.over = true;
                                alert('你赢啦~');
                                _this.reset();
                            }
                        }                        
                    };

                    // 还没有胜利 计算机开始下 
                    if( !_this.over ) {
                        _this.me = !_this.me;
                        _this.computerAI();
                    }
                }

            }
        },

        computerAI: function () {
            var myScore = [];
            var computerScore = [];
            var max = 0;
            var u = 0, v = 0;
            var isHaveEmpty = false;

            // 每个点落子的分数数组初始化
            for (var i = 0; i < 15; i++) {
                myScore[i] = [];
                computerScore[i] = [];
                for (var j = 0; j < 15; j++) {
                    myScore[i][j] = 0;
                    computerScore[i][j] = 0;
                }
            };

            // 计算每个点落子的分数
            for (var i = 0; i < 15; i++) {
                for (var j = 0; j < 15; j++) {

                    // 这个点是空的
                    if( this.borad[i][j] === 0 ) {
                        isHaveEmpty = true;

                        for (var k = 0; k < this.count; k++) {
                            if( this.wins[i][j][k] ) {

                                if( this.myWin[k] == 1 ) {
                                    myScore[i][j] += 200;
                                } else if( this.myWin[k] == 2 ) {
                                    myScore[i][j] += 400;
                                } else if( this.myWin[k] == 3 ) {
                                    myScore[i][j] += 2000;
                                } else if( this.myWin[k] == 4 ) {
                                    myScore[i][j] += 100000;
                                }
                                
                                if( this.computerWin[k] == 1 ) {
                                    computerScore[i][j] += 220;
                                } else if( this.computerWin[k] == 2 ) {
                                    computerScore[i][j] += 420;
                                } else if( this.computerWin[k] == 3 ) {
                                    computerScore[i][j] += 2100;
                                } else if( this.computerWin[k] == 4 ) {
                                    computerScore[i][j] += 200000;
                                }
                            }
                        };
                        if( myScore[i][j] > max ) {
                            max = myScore[i][j];
                            u = i;
                            v = j;
                        } else if ( myScore[i][j] == max ) {
                            if( computerScore[i][j] > computerScore[u][v] ) {
                                u = i;
                                v = j;
                            }
                        }


                        if( computerScore[i][j] > max ) {
                            max = computerScore[i][j];
                            u = i;
                            v = j;
                        } else if ( computerScore[i][j] == max ) {
                            if( myScore[i][j] > myScore[u][v] ) {
                                u = i;
                                v = j;
                            }
                        }
                    }
                }
            };

            // 如果棋盘子下满了则平局
            if( !isHaveEmpty ) {
                alert('打平啦~');
                this.reset();
                return this;
            }

            this.oneStep(u, v, false);
            this.borad[u][v] = 2;


            // 查看当前的赢法
            for (var k = 0; k < this.count; k++) {
                if( this.wins[u][v][k] ) {
                    this.computerWin[k]++;
                    this.myWin[k] = 6;

                    if( this.computerWin[k] == 5 ) {
                        this.over = true;
                        alert('计算机赢啦~');
                        this.reset();
                        return false;
                    }
                }                        
            };

            // 还没有胜利 计算机开始下 
            if( !this.over ) {
                this.me = !this.me;
            }

        },

        drawChess : function () {

            var ctx = this.ctx;

            ctx.strokeStyle = '#bfbfbf';

            for( var i = 0; i < 15; i++ ) {
                ctx.moveTo(15 + i*30, 15);
                ctx.lineTo(15 + i*30, 435);
                ctx.stroke();

                ctx.moveTo(15, 15 + i*30);
                ctx.lineTo(435, 15 + i*30);
                ctx.stroke();
            }


            // this.oneStep(3 ,3, true);
            // this.oneStep(3 ,4 ,false);
        },

        oneStep: function (i, j, me) {
            var ctx = this.ctx;

            var x = i * 30 + 15;
            var y = j * 30 + 15;

            ctx.beginPath();
            ctx.arc(x, y, 13, 0, 2 * Math.PI);

            var gradient = ctx.createRadialGradient(x + 2, y - 2, 13,x + 2, y - 2, 0);
            if( me ) { 
                gradient.addColorStop(0, '#0A0A0A'); 
                gradient.addColorStop(1, '#636766'); 
            } else {
                // gradient.addColorStop(0, '#d1d1d1'); 
                // gradient.addColorStop(1, '#f9f9f9');
                gradient.addColorStop(0, '#EA6974'); 
                gradient.addColorStop(1, '#E2B2B6'); 
            }
            ctx.fillStyle = gradient;
            ctx.fill();
            ctx.closePath();
        }

    };

    game.init( 'game' );


    </script>
</body>
</html>